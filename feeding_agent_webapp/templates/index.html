<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能投喂决策系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif, -apple-system, BlinkMacSystemFont; background-color: #f0f4f8; }
        .form-input:focus { box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); border-color: #4299e1; }
        .prose h3 { margin-top: 0; }
        .prose p { margin-bottom: 0.5rem; }
        [contenteditable]:focus {
            background-color: #fefcbf;
            outline: 2px solid #facc15;
        }
        .nav-btn {
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transform: translateY(-2px);
        }
        .hidden { display: none; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4 md:p-8">

        <div class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">智能投喂决策系统</h1>
            <p class="text-xl md:text-2xl text-gray-500 mt-2">Intelligent Feeding Decision System</p>
        </div>

        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap justify-center items-center mb-6 bg-white p-3 rounded-xl shadow-md gap-4">
                <div id="system-tabs" class="flex flex-wrap gap-3"></div>
                <button id="add-system-btn" class="ml-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-sm">
                    + 新增系统
                </button>
            </div>
            <div id="main-container" class="space-y-8"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.getElementById('main-container');
            const systemTabs = document.getElementById('system-tabs');
            const addSystemBtn = document.getElementById('add-system-btn');

            let changesToSave = {};

            const paramConfig = [
                { name: 'average_water_temp', label: '平均水温 (°C)', placeholder: '例如: 28.5' },
                { name: 'average_do', label: '平均溶解氧 (mg/L)', placeholder: '例如: 6.0' },
                { name: 'average_ph', label: '平均pH值', placeholder: '例如: 8.2' },
                { name: 'ammonia_nitrogen', label: '氨氮浓度 (mg/L)', placeholder: '例如: 0.1' },
                { name: 'nitrite_nitrogen', label: '亚硝酸盐浓度 (mg/L)', placeholder: '例如: 0.05' },
                { name: 'age_in_days', label: '养殖天数 (天)', placeholder: '例如: 50' },
                { name: 'weight', label: '平均体重 (g)', placeholder: '例如: 10.5' },
                { name: 'shrimp_loading_cap', label: '放养量 (万尾)', placeholder: '例如: 30' },
                { name: 'survival_rate', label: '存活率 (%)', placeholder: '例如: 85' },
                { name: 'number_of_meals', label: '每日餐数', placeholder: '例如: 4' },
                { name: 'remarks', label: '备注信息', placeholder: '特殊天气、水质变化等', type: 'text' },
                { name: 'actual_feeding_amount', label: '实际投喂量 (kg)', placeholder: '选填, 用于记录', type: 'number' }
            ];

            const createInput = (name, label, placeholder, type = 'number', value = '', step = 'any') => `
                <div class="flex flex-col">
                    <label for="${name}" class="mb-1.5 text-base font-medium text-gray-700">${label}</label>
                    <input type="${type}" id="${name}" name="${name}" placeholder="${placeholder}" step="${step}" value="${value}"
                           class="form-input w-full px-4 py-2.5 text-base border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            `;

            const createSystemCard = (systemId, data) => {
                const card = document.createElement('div');
                card.className = 'system-card';
                card.dataset.systemId = systemId;
                card.innerHTML = `
                    <div class="p-6 md:p-8 bg-white rounded-2xl shadow-lg">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold text-gray-800">系统ID: ${systemId}</h2>
                            <div class="flex items-center gap-3">
                                <button class="save-changes-btn hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105">保存修改</button>
                                <button class="add-row-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105">新增日志行</button>
                                <a href="/download_log/${systemId}" class="download-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105" download>下载日志</a>
                            </div>
                        </div>

                        <div class="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
                             <div class="text-left mb-6">
                                <h3 class="text-2xl font-semibold text-gray-700">输入养殖参数</h3>
                                <p class="text-lg text-gray-500">Enter Aquaculture Parameters</p>
                            </div>
                            <form class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6">
                                ${paramConfig.map(p => createInput(p.name, p.label, p.placeholder, p.type)).join('')}
                            </form>
                            <div class="mt-8 text-center">
                                <button class="predict-btn bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-3 px-8 rounded-lg text-lg shadow-md transition-transform transform hover:scale-105">
                                    获取智能投喂建议
                                </button>
                            </div>
                        </div>

                        <div class="result-container mt-6 prose max-w-none prose-lg"></div>

                        <div class="log-container mt-8">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">历史日志 / Historical Logs</h3>
                            <div class="overflow-x-auto bg-white rounded-lg shadow-md border border-gray-200">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100"></thead>
                                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                card.querySelector('.predict-btn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    const form = e.target.closest('div.mb-8').querySelector('form');
                    const inputs = form.querySelectorAll('input');
                    const resultContainer = card.querySelector('.result-container');
                    const requestData = { system_id: systemId };
                    inputs.forEach(input => {
                        if (input.value !== '') {
                             requestData[input.name] = input.type === 'number' ? parseFloat(input.value) : input.value;
                        }
                    });

                    resultContainer.innerHTML = '<div class="flex justify-center items-center p-6"><div class="spinner"></div><p class="ml-4 text-gray-600">正在分析，请稍候...</p></div>';

                    try {
                        const response = await fetch('/predict', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            resultContainer.innerHTML = marked.parse(result.recommendation);
                        } else {
                            throw new Error(result.error || '预测失败');
                        }
                    } catch (error) {
                        resultContainer.innerHTML = `<p class="text-red-500">发生错误: ${error.message}</p>`;
                    }
                });

                card.querySelector('.save-changes-btn').addEventListener('click', async () => saveChanges(systemId));
                card.querySelector('.add-row-btn').addEventListener('click', () => addRow(systemId));

                return card;
            };

            const loadSystemData = async (systemId) => {
                const card = mainContainer.querySelector(`.system-card[data-system-id='${systemId}']`);
                if (!card) return;

                const tableHead = card.querySelector('thead');
                const tableBody = card.querySelector('tbody');
                tableHead.innerHTML = '<tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">加载中...</th></tr>';
                tableBody.innerHTML = '';

                try {
                    const response = await fetch(`/get_log/${systemId}`);
                    const data = await response.json();

                    if (response.ok && data.columns && data.records) {
                        tableHead.innerHTML = `<tr>${data.columns.map(col => `<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">${col}</th>`).join('')}</tr>`;
                        tableBody.innerHTML = data.records.map(row => `
                            <tr data-doc-id="${row.doc_id}">
                                ${data.columns.map(col => `
                                    <td class="px-4 py-3 whitespace-nowrap text-gray-700 text-sm" contenteditable="true" data-column="${col}">${row[col] !== null && row[col] !== undefined ? row[col] : ''}</td>
                                `).join('')}
                            </tr>
                        `).join('');

                        const latestRecord = data.records[0] || {};
                        const form = card.querySelector('form');
                        paramConfig.forEach(p => {
                           if(latestRecord[p.name] !== undefined && p.name !== 'remarks' && p.name !== 'actual_feeding_amount') {
                               const input = form.querySelector(`[name="${p.name}"]`);
                               if(input) input.value = latestRecord[p.name];
                           }
                        });

                    } else {
                        tableHead.innerHTML = '<tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">无数据</th></tr>';
                        tableBody.innerHTML = `<tr><td class="px-4 py-4 text-gray-500" colspan="100%">${data.error || '未能加载日志记录。'}</td></tr>`;
                    }
                } catch (error) {
                    tableHead.innerHTML = '<tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">错误</th></tr>';
                    tableBody.innerHTML = `<tr><td class="px-4 py-4 text-red-500" colspan="100%">加载日志失败: ${error.message}</td></tr>`;
                }
            };

            const saveChanges = async (systemId) => {
                const changes = changesToSave[systemId];
                if (!changes) return;

                try {
                    const response = await fetch('/update_log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ system_id: systemId, changes: changes })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to save changes');
                    }
                    delete changesToSave[systemId];
                    mainContainer.querySelector(`.system-card[data-system-id='${systemId}'] .save-changes-btn`).classList.add('hidden');
                     alert('修改已保存！');
                } catch (error) {
                    alert(`保存失败: ${error.message}`);
                }
            };

            const switchTab = (systemId) => {
                document.querySelectorAll('.system-card').forEach(card => card.classList.add('hidden'));
                const activeCard = document.querySelector(`.system-card[data-system-id='${systemId}']`);
                if (activeCard) activeCard.classList.remove('hidden');

                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.querySelector(`.nav-btn[data-system-id='${systemId}']`);
                if (activeBtn) activeBtn.classList.add('active');

                localStorage.setItem('activeSystemId', systemId);
            };

            const reloadWithState = async () => {
                const activeSystemId = localStorage.getItem('activeSystemId');
                const response = await fetch('/get_systems');
                const systems = await response.json();

                mainContainer.innerHTML = '';
                systemTabs.innerHTML = '';

                if (systems.length > 0) {
                    systems.forEach(systemId => {
                        const card = createSystemCard(systemId);
                        mainContainer.appendChild(card);
                        loadSystemData(systemId);

                        const tab = document.createElement('button');
                        tab.textContent = `系统 ${systemId}`;
                        tab.className = 'nav-btn px-4 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-blue-500 hover:text-white';
                        tab.dataset.systemId = systemId;
                        tab.addEventListener('click', () => switchTab(systemId));
                        systemTabs.appendChild(tab);
                    });

                    const idToActivate = activeSystemId && systems.includes(activeSystemId) ? activeSystemId : systems[0];
                    switchTab(idToActivate);
                } else {
                     mainContainer.innerHTML = '<p class="text-center text-gray-500">暂无系统，请点击“新增系统”开始。</p>';
                }
            };

            reloadWithState();

            addSystemBtn.addEventListener('click', () => {
                const systemId = prompt('请输入新的系统ID:');
                if (systemId && systemId.trim()) {
                    localStorage.setItem('activeSystemId', systemId.trim());
                    reloadWithState();
                }
            });

            const addRow = async (systemId) => {
                 const confirmed = confirm(`确定要为系统 ${systemId} 新增一个空的日志行吗？`);
                if (confirmed) {
                    try {
                        const response = await fetch('/add_row', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ system_id: systemId })
                        });
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || 'Failed to add row');
                        }
                        reloadWithState();
                    } catch (error) {
                        alert(`新增失败: ${error.message}`);
                    }
                }
            };

             mainContainer.addEventListener('input', (event) => {
                const cell = event.target;
                if (cell.tagName === 'TD' && cell.isContentEditable) {
                    const card = cell.closest('.system-card');
                    const saveBtn = card.querySelector('.save-changes-btn');
                    const systemId = card.dataset.systemId;
                    const docId = cell.closest('tr').dataset.docId;
                    const column = cell.dataset.column;
                    const value = cell.innerText;

                    if (!changesToSave[systemId]) changesToSave[systemId] = {};
                    if (!changesToSave[systemId][docId]) changesToSave[systemId][docId] = {};

                    changesToSave[systemId][docId][column] = value;
                    saveBtn.classList.remove('hidden');
                }
            });
        });
    </script>
</body>
</html>